<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>OpenPhone Call</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; text-align:center; padding:40px; }
    h2 { margin: 0 0 12px; }
    .btn { display:inline-block; padding:14px 20px; background:#0a66ff; color:#fff; text-decoration:none; border-radius:10px; font-weight:600; }
    .link { display:block; margin-top:14px; }
    .muted { color:#666; font-size:0.95rem; margin-top:10px; }
    iframe { display:none; width:0; height:0; }
  </style>
</head>
<body>
  <h2>Place call with OpenPhone</h2>
  <p id="tip">If nothing happens, tap the button below.</p>

  <a id="callBtn" class="btn" href="#">üìû Open in OpenPhone</a>
  <a id="fallback" class="link" href="#" target="_blank" rel="noopener">Open web inbox instead</a>
  <div class="muted">Tip (iPhone): you‚Äôll see ‚ÄúOpen in OpenPhone?‚Äù ‚Äî tap **Open**.</div>

  <iframe id="shim" title="deep-link-shim"></iframe>

  <script>
    const qs = new URLSearchParams(location.search);
    const to   = qs.get('number') || '';
    const from = qs.get('from')   || '';
    const inbox = qs.get('inbox') || ''; // optional inbox id

    const deep = 'openphone://dial?number=' + encodeURIComponent(to) +
                 '&from=' + encodeURIComponent(from) + '&action=call';
    const web  = inbox ? ('https://my.openphone.com/inbox/' + encodeURIComponent(inbox))
                       : 'https://my.openphone.com/inbox';

    const isIOS     = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);

    // Buttons
    const btn = document.getElementById('callBtn');
    const tip = document.getElementById('tip');
    btn.href = deep;
    document.getElementById('fallback').href = web;

    function tryDeepLinkAuto() {
      // Desktop/Android: try auto, but do NOT auto-fallback (so prompts aren‚Äôt stolen)
      try {
        if (isAndroid) {
          window.location.href = deep;
        } else {
          // Desktop: hidden iframe technique
          document.getElementById('shim').src = deep;
        }
      } catch(e) {}
    }

    if (isIOS) {
      // iPhone: require explicit tap (best reliability)
      tip.textContent = 'Tap the button to open the OpenPhone app and place the call.';
      // no auto attempt
    } else {
      // Android/Desktop: gentle auto attempt, user can still click button if blocked
      setTimeout(tryDeepLinkAuto, 150);
    }

    // Optional: allow re-trying by tapping the button (works everywhere)
    btn.addEventListener('click', function(e){
      // leave default href so it navigates
      // you can also e.preventDefault() and set window.location if desired
    });
  </script>
</body>
</html>
